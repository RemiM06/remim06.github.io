<!DOCTYPE html>
<html>
<head>
    <title>Interaction 3D avec Three.js et Leaflet.js</title>
    <style>
        body { margin: 0; display: flex; }
        #map { height: 100vh; width: 50vw; }
        #globe { height: 100vh; width: 50vw; }
        #enableMotion {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #enableMotion:hover {
            background-color: #45a049;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>

    <button id="enableMotion">Activer les capteurs</button>

<div id="map"></div>
<div id="globe"></div>

<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.148.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.148.0/examples/jsm/"
    }
}
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const map = L.map('map').setView([51.505, -0.09], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, (window.innerWidth / 2) / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth / 2, window.innerHeight);
    document.getElementById('globe').appendChild(renderer.domElement);

    window.addEventListener('resize', () => {
        const aspect = (window.innerWidth / 2) / window.innerHeight;
        camera.aspect = aspect;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth / 2, window.innerHeight);
    });

    const geometry = new THREE.SphereGeometry(1, 32, 32);
    const texture = new THREE.TextureLoader().load('nasa-earth.jpg');
    const material = new THREE.MeshPhongMaterial({ map: texture });
    const earth = new THREE.Mesh(geometry, material);
    scene.add(earth);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    directionalLight.position.set(5, 3, 5);
    scene.add(directionalLight);

    camera.position.set(3, 3, 3); // Initial camera position
    camera.lookAt(new THREE.Vector3(0, 0, 0)); // Look at the center of the Earth
    
    const controls = new OrbitControls(camera, renderer.domElement);

    // Device orientation event listener
    window.addEventListener("deviceorientation", handleOrientation);

    function handleOrientation(event) {
        const alpha = event.alpha ? THREE.Math.degToRad(event.alpha) : 0; // Z-axis rotation
        const beta = event.beta ? THREE.Math.degToRad(event.beta) : 0; // X-axis rotation
        const gamma = event.gamma ? THREE.Math.degToRad(event.gamma) : 0; // Y-axis rotation

        earth.rotation.set(beta, gamma, alpha);
    }

    fetch('https://restcountries.com/v3.1/all')
        .then(response => response.json())
        .then(data => {
            data.forEach(country => {
                if (country.region === "Europe" && country.latlng) {
                    addCountryMarker(country.latlng[0], country.latlng[1], country.flags.png);
                }
            });
        });

    function latLongToVector3(lat, lon) {
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        const x = -Math.sin(phi) * Math.cos(theta);
        const z = Math.sin(phi) * Math.sin(theta);
        const y = Math.cos(phi);
        return new THREE.Vector3(x, y, z);
    }

    function addCountryMarker(lat, lon, flagUrl) {
        L.marker([lat, lon]).addTo(map).on('click', () => {
            focusOnCountry(lat, lon);
        });

        const loader = new THREE.TextureLoader();
        loader.load(flagUrl,
            function(texture) {
                const geometry = new THREE.SphereGeometry(0.01, 32, 32);
                const material = new THREE.MeshBasicMaterial({ map: texture });
                const marker = new THREE.Mesh(geometry, material);
                const position = latLongToVector3(lat, lon);
                marker.position.copy(position.multiplyScalar(1.01));
                earth.add(marker); 
            },
            undefined,
            function(err) {
                console.error('Erreur lors du chargement du drapeau:', err);
            }
        );
    }

    function focusOnCountry(lat, lon) {
        const targetPosition = latLongToVector3(lat, lon).multiplyScalar(1.5); // Adjust distance as needed

        gsap.to(camera.position, {
            x: targetPosition.x,
            y: targetPosition.y,
            z: targetPosition.z,
            duration: 1,
            onUpdate: () => controls.update()
        });

        camera.lookAt(new THREE.Vector3(0, 0, 0));
        
        controls.target.copy(latLongToVector3(lat, lon));
        controls.update();
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    animate();

</script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
</body>
</html>